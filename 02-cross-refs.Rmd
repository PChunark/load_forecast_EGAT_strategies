# Electricity profiles
This chapter provides electricity profiles and a R coding technique. 
Electricity profiles are illustrated to give an insight into profile behavior. 
R coding technique are given in order to understand the process flow and 
manage the big data obtained from several sources in the organization.

## Initial settings

Before the project starts, library are required as follows:

```{r, library setting, results='hide', message=FALSE}
library(tidyverse) #For data manipulation
library(readxl) #For reading the excel sheet
library(scales)
library(glue)
library(knitr)
```

Design a theme and lines for figures

```{r, theme setting, results='hide', message=FALSE, warning=FALSE}
ThemeLine <- 
  theme_bw() +
  theme(
    panel.border=element_rect(fill=NA),
    panel.grid.minor = element_line(color = NA), 
    #    axis.title=element_text(size=5),
    #    axis.text.x = element_text(hjust=1,size = 10, angle = 0),
    axis.line=element_line(colour="black"),
    panel.background=element_rect(fill = "white"),
    panel.grid.major.x=element_line(linetype="dashed",colour="grey",linewidth = 0.5),
    panel.grid.major.y = element_blank(),
    # panel.grid.major=element_blank(),
    strip.background=element_rect(fill="white", colour="white"),
    strip.text.x = element_text(size=10, colour = "black", angle = 0,face="bold"),
    axis.text.x=element_text(size = 10,angle=45, vjust=0.9, hjust=1, margin = unit(c(t = 0.3, r = 0, b = 0, l = 0), "cm")),
    axis.text.y=element_text(size = 10,margin = unit(c(t = 0, r = 0.3, b = 0, l = 0), "cm")),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 10),
    axis.ticks.length=unit(-0.15,"cm")
  )
linepalette1 <- c("#4DAF4A","#FF7F00","#377EB8","#E41A1C","#984EA3","#F781BF","#8DD3C7","#FB8072","#80B1D3","#FDB462","#B3DE69","#FCCDE5","#D9D9D9","#BC80BD","#CCEBC5","#FFED6F","#7f878f","#A65628","#FFFF33")
linepalette2 <- c("#E41A1C","#FF7F00","#377EB8","#B3DE69","#4DAF4A","#984EA3","#F781BF","#8DD3C7","#FB8072","#80B1D3","#FDB462","#FCCDE5","#D9D9D9","#BC80BD","#CCEBC5","#FFED6F","#7f878f","#A65628","#FFFF33")

```

Create list to store variable

```{r, make list}
#----- Make a list of profile to store data -----####

profiledata <- list()
profilefigure <- list()
summarydata <- list()
```

```{r, variable for output}
#----- Make variable for output directory -----####
outfigdir <- c("figures/")
```
## The EGAT electrity sale profiles

### The 2019 MEA EGAT sale profile
The electricity sale profile from EGAT is given by the Power System Control and Operation Division (ฝ่ายควบคุมระบบกำลังไฟฟ้า).


```{r, MEA EGAT sale}
#----- The 2019 MEA EGAT sale profile ----####
# Profile data ####
profile <- 
  read_excel("raw_data/raw_data_profiles/02_Hourly Sale_NetGen_2019.xlsx",
           sheet = "Load Curve",
           range = "C3:D17523"
            ) %>% 
  select(datetime = `Date/Time`, MEA) %>% 
  mutate(date = date(datetime),
         time = format(as.POSIXct(datetime),"%H:%M:%S"),
         year = year(datetime),
         month = month(datetime),
         day = day(datetime)) %>% 
  select(datetime, date, time, year, month, day, MEA)
profile
```

The peak, minimun in the unit of MW, and an electricity sale to MEA in GWh from the profile are calculated.
The electricity sale to MEA (in GWh) is calculated by the summation of profile in MW divided by 2000.

The reason that divided by **2000** is the profile is given a time stamp in **every 30-min**. There are **17520** values. Therefore, the summation of profile is divided by **2** to get the results in **every 1 hr**. We divided the output again by **1000** to convert the unit **from MWh to GWh** (see equation \@ref(eq:energycal)).

\begin{equation}
 Ene_{i/2}=\frac{\sum_{i=1}^{17520} (profile_{i})}{2*1000}
 (\#eq:energycal)
\end{equation} 

```{r, find peak and min MW}
# Summary data ####
maxv <- ceiling(max(profile$MEA)) # Get a peak MW
minv <- floor(min(profile$MEA)) # Get a min MW
energy <- sum(profile$MEA)/2000 # Calculate the energy
```

The peak and minimum MW days are also needed to assess in order to provide the maximum and minimum a saled electricity from EGAT to MEA.
```{r, peak & min day}
peak_day <- profile %>% #Find a peak day
            group_by(year) %>% 
            filter(MEA == max(MEA)) %>% 
            pull(datetime)
min_day <- profile %>% #Find a peak day
           group_by(year) %>% 
           filter(MEA == min(MEA)) %>% 
           pull(datetime)
```

Load factor is calculated by the energy in equation \@ref(eq:energycal) divided a maximum energy. A maximum energy is **the peak multiplied by 8760 hours**. Result is presented in a percentage.

\begin{equation}
 LF_{t}=\frac{Energy_{t}}{Peak_{d,h} * 8760}*100 
 (\#eq:loadfactorcal)
\end{equation} 

Where, $LF_{t}$ denotes the load factor at year $t$ in percentage.\
$Energy_{t}$ denotes the calculated energy from equation \@ref(eq:energycal) at year $t$ in GWh.\
$Peak_{d,h}$ denotes the peak electricity sale on the date $d$ at time $h$.


```{r, load factor}
load_factor <- percent((energy*10^3)/(maxv*8760), 
                       accuracy = 0.01, 
                       decimal.mark = ".")
```

Create a table to store relevant data.
```{r, summary data}
summary <- tibble(peak_day = peak_day,
                  min_day = min_day,
                  peak_mw = maxv, 
                  min_mw = minv, 
                  energy_gwh = energy,
                  load_factor = load_factor) # combine all data in 1 table
```
In 2019, the electricity sale to MEA by EGAT reached it peak **`r format(maxv, scientific=FALSE, big.mark = ",")`** MW on **`r peak_day`**. The energy (electricity) sale to MEA was **`r format(energy, scientific=FALSE, big.mark = ",")`** GWh.
The summary of the electricity sale to MEA by EGAT in 2019 is given in Table \@ref(tab:sum-egat-to-mea-2019).

```{r sum-egat-to-mea-2019, echo=FALSE, tidy=FALSE}
knitr::kable(
  summary, caption = 'Summary of EGAT sale to MEA in 2019!',
  booktabs = TRUE
)
```


The electricity sale profile from EGAT to MEA in 2019 is illustrated (see Figure \@ref(fig:EGAT-sale-to-MEA-2019)).
```{r, EGAT sale to MEA in 2019}
profile_plot <-
    ggplot() + 
    geom_line(data=profile, 
              aes(x = datetime, 
                  y = MEA,
                  group = month,
                  color = as.factor(month)),
              show.legend = FALSE) +
    ThemeLine +
    labs(x = NULL,
         y = "EGAT sale to MEA (MW)")+
    scale_x_datetime(breaks=date_breaks("1 month"), 
                     labels=date_format("%b %y")) +
    scale_y_continuous(breaks = seq(0, round(maxv,-3),1000),
                       limits = c(0, round(maxv, -3))) +  
    scale_color_manual(values = linepalette1) +
    geom_point(data=summary,
               aes(x = peak_day, y = peak_mw))+
    geom_text(data = summary,
              aes(x = peak_day, y = round(maxv, -3)),
              label = glue("Peak {maxv} MW \n@ {peak_day}"))+
    geom_point(data=summary,
               aes(x = min_day, y = min_mw))+
    geom_text(data = summary,
              aes(x = min_day, y = round(minv, -3)),
              label = glue("Minimum {minv} MW \n@ {min_day}"),
              hjust = 0,
              vjust = 1.5)
```


```{r, EGAT-sale-to-MEA-2019, echo=FALSE, fig.cap='EGAT electricity sale profile to MEA in 2019.', fig.align='center', out.width= '90%'}
profile_plot
```

Outputs are saved. Outputs are listed as follows:

+ Create a file name
- Save a plot in a directory
* Save profile data in a list
* Save figures in a list
* Save summary data in a list
```{r, save output}

outputfigure <- paste0(outfigdir, "mea_egtsle_2019.png")
ggsave(profile_plot, file = outputfigure, dpi = 150, width = 15, height = 5, units = "in", limitsize = FALSE)
profiledata <- c(profiledata, list("mea_egtsle_2019" = profile))
profilefigure <- c(profilefigure, list("mea_egtsle_2019" = profile_plot))
summarydata <- c(summarydata, list("sum_mea_egtsle_2019" = summary))
```


### The 2019 MEA EGAT sale profile