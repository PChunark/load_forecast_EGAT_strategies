# MEA electricity calculation

This section explains the MEA electricity calculation. Existing VSPPs electricity generation are needed. Such a generation is obtained from R code chunks provided in Chapter \@ref(vsppsituation).\


This study merges 2 MEA's electricity load data sets as follows:

1. A budget load 2566–2567 (2023–2024)
2. An electricity load from the NIDA study approved on 25 August 2022

The budget load provides a required electricity demand from the MEA areas. It covers from EGAT sales to total net generation for 3 utilities' power system. An estimated electricity generation ranges from 2023-2028.\

The MEA electricity load from the NIDA study is merged to the budget load from 2029 onward.\

R code chunks to extract the budget load and the NIDA load are given below.

* The budget load 2566–2567 (2023–2024) code chunk

```{r b_mea_ene, echo=TRUE, warning=FALSE, message=FALSE}
b_mea_ene <-
  
  read_excel("raw_data/01 EGAT_20Oct2022_งบ66 67_Final_Sent อศง.xlsx",
             sheet = "MEA",
             range = "A8:N27",
             col_names = c("sector","a", 2017:2028)) %>%
  select(!a) %>% 
  drop_na() %>% 
  pivot_longer(-sector, names_to = "year", values_to = "mea_gwh") %>%
  mutate(year = as.numeric(year),
         year_th = as.numeric(year) + 543) %>% 
  filter(sector == "MEA's System Requirement")
```

* The electricity load from the NIDA study approved on 25 August 2022

```{r pdp2022_mea_ene, echo=TRUE, warning=FALSE, message=FALSE}

pdp2022_mea_ene <-
  
read_excel("raw_data/93 EGAT_25Aug2022_13 Energy ภาพรวม NIDA_BAU_ND_EE70__Sent.xlsx",
           sheet = "MEA",
           range = "A8:AB33",
           col_names = c("sector","a", 2012:2037)) %>%
  select(!a) %>% 
  drop_na() %>% 
  pivot_longer(-sector, names_to = "year", values_to = "mea_gwh") %>%
  mutate(year = as.numeric(year),
         year_th = as.numeric(year) + 543) %>% 
  filter(sector == "MEA's System Requirement")
```

* Merge 2 datasets
The `rbind` function combined both the MEA's budget load and the NIDA's load.
```{r newmea_ene, echo=TRUE, message=FALSE, warning=FALSE}
newmea_ene <-
  
  rbind(b_mea_ene %>% filter(year >= 2019), 
        pdp2022_mea_ene %>% filter(year >=2029))
```

```{r annonewmea_ene, echo=FALSE, warning=FALSE, message=FALSE}
annonewmeaene2019 <-
  newmea_ene %>% 
  filter(year == 2019)
  
annonewmeaene2022 <-
  newmea_ene %>% 
  filter(year == 2022)

annonewmeaene2019 <-
  newmea_ene %>% 
  filter(year == 2019)

annonewmeaene2025 <-
  newmea_ene %>% 
  filter(year == 2025)

annonewmeaene2028 <-
  newmea_ene %>% 
  filter(year == 2028)

annonewmeaene2037 <-
  newmea_ene %>% 
  filter(year == 2037)
  
```

The MEA electricity requirement increases from 53,290 GWh in 2022 to 71,127 GWh in 2037. It increases `r round((((71127/53290)^(1/(2037-2022)))-1)*100,3)`% annually. 

```{r plot-newmeaene, echo=FALSE, warning=FALSE, message=FALSE, fig.cap='Estimated MEA electricity requirement from the budget load and the NIDA study', fig.align='center', out.width= '90%'}
# ggplotly(
  newmea_ene %>% 
  ggplot(aes(x = year, y = mea_gwh))+
  geom_line(aes(group = sector, color = "salmon"),
            show.legend = FALSE)+
  geom_point(shape = 21,
             size = 2,
             color = "salmon",
             fill = "grey")+
  geom_vline(xintercept = 2019)+
  geom_vline(xintercept = 2022)+
  geom_vline(xintercept = 2028)+
  geom_vline(xintercept = 2037)+
  geom_text(label = "Historical data",
            aes(x = 2020.5, y = 80000),
            color = "dodgerblue",
            show.legend = FALSE,
            inherit.aes = FALSE)+
  geom_text(label = "Budget load 2566–2567 \n (2023–2024)",
            aes(x = 2025, y = 80000),
            color = "dodgerblue",
            show.legend = FALSE,
            inherit.aes = FALSE)+
  geom_text(label = "NIDA load 25 AUG 2022",
            aes(x = 2032.5, y = 80000),
            color = "dodgerblue",
            show.legend = FALSE,
            inherit.aes = FALSE)+
  scale_x_continuous(breaks = c(2019, 2022, 2025, 2028, 2030, 2035, 2037))+
  scale_y_continuous(breaks = seq(0,80000, 5000),
                     limits = c(0,80000),
                     labels = comma)+
  ThemeLine+
  labs(x = NULL,
       y = "MEA's electricity requirement (GWh)")+
  geom_text_repel(data = annonewmeaene2019,
                  aes(x = year, y = mea_gwh,
                      label = paste0(formatC(annonewmeaene2019$mea_gwh, format = "d", big.mark = ","), " GWh")),
                  hjust = 0.5,
                  size = 3.5,
                  nudge_x = 1,
                  nudge_y = 10000,
                  inherit.aes = FALSE)+
  geom_text_repel(data = annonewmeaene2022,
                  aes(x = year, y = mea_gwh,
                      label = paste0(formatC(annonewmeaene2022$mea_gwh, format = "d", big.mark = ","), " GWh")),
                  hjust = 0.3,
                  size = 3.5,
                  nudge_x = 1,
                  nudge_y = 10000,
                  inherit.aes = FALSE)+
  geom_text_repel(data = annonewmeaene2025,
                  aes(x = year, y = mea_gwh,
                      label = paste0(formatC(annonewmeaene2025$mea_gwh, format = "d", big.mark = ","), " GWh")),
                  hjust = 1,
                  size = 3.5,
                  nudge_x = 1,
                  nudge_y = -10000,
                  inherit.aes = FALSE)+
  geom_text_repel(data = annonewmeaene2028,
                  aes(x = year, y = mea_gwh,
                      label = paste0(formatC(annonewmeaene2028$mea_gwh, format = "d", big.mark = ","), " GWh")),
                  hjust = 0.2,
                  size = 3.5,
                  nudge_x = 1,
                  nudge_y = 10000,
                  inherit.aes = FALSE)+
  geom_text_repel(data = annonewmeaene2037,
                  aes(x = year, y = mea_gwh,
                      label = paste0(formatC(annonewmeaene2037$mea_gwh, format = "d", big.mark = ","), " GWh")),
                  hjust = 0.5,
                  size = 3.5,
                  nudge_x = -1.2,
                  nudge_y = -10000,
                  inherit.aes = FALSE)
# )
```


## VSPP in MEA in PDP2018REV1

* Extract VSPP data\
The electricity generation from VSPP in the MEA area was divided into existing VSPPs and newly VSPP contracts. Solar and biomass for communities were added in a newly VSPP category. 
```{r meavspppdp2018r1, echo=TRUE, warning=FALSE, message=FALSE}
mea_vspp_pdp2018r1 <-
  
  read_excel("raw_data/01 Load_PDP2018 ปรับ VSPP_13Jan2020_Final (PDP2018R1).xlsx",
           sheet = "I_VSPP",
           range = "B29:L51",
           col_names = c("year","solar", "wind", "hydro", "biomass", "biogas", "waste", "crop", "geothermal", "re_eeothers", "cogen")) %>%
  replace(is.na(.), 0 ) %>%
  mutate(total = rowSums(across(c(solar:cogen)))) %>% 
  pivot_longer(-year, names_to = "fuel", values_to = "mea_gwh") %>% 
  mutate(year_th = as.numeric(year) + 543) 
```

```{r plot-meavspppdp2018r1, echo=FALSE, warning=FALSE, message=FALSE, fig.cap='Projected electricity generation from existing VSPP contracts in the PDP2018 revision 1', fig.align='center', out.width= '90%'}
mea_vspp_pdp2018r1 %>%
  filter(!fuel %in% c("biogas","biomass","crop","geothermal","re_eeothers","wind")) %>% 
  ggplot(aes(x = year, y = mea_gwh)) + 
  geom_line(aes(group = fuel, color = fuel),
            show.legend = FALSE) +
  facet_wrap(~fuel,
             scales = "free_y")+
  ThemeLine+
  labs(x = NULL,
       y = "Electricity generation (GWh)")+
  scale_color_manual(values = linepalette1)
```


```{r mea_newvspp_pdp2018r1, echo=FALSE, warning=FALSE, message=FALSE}
mea_newvspp_pdp2018r1 <-
  
  read_excel("raw_data/01 Load_PDP2018 ปรับ VSPP_13Jan2020_Final (PDP2018R1).xlsx",
             sheet = "I_VSPP",
             range = "M29:T51",
             col_names = c("biomass", "biogas", "solar_community", "waste", "wind", "ind_waste", "biomass_community", "ee")) %>%
  replace(is.na(.), 0 ) %>%
  mutate(year = 2015:2037,
         total = rowSums(across(c(biomass:ee)))) %>% 
  pivot_longer(-year, names_to = "fuel", values_to = "mea_gwh") %>% 
  mutate(year = as.numeric(year),
         year_th = as.numeric(year + 543)) 
```

```{r}
mea_newvspp_pdp2018r1 %>% 
  ggplot(aes(x = year, 
             y = mea_gwh))+
  geom_line(aes(group = fuel, color = fuel),
            show.legend = FALSE)+
  facet_wrap(~fuel,
             scales = "free_y")+
  ThemeLine+
  labs(x = NULL,
       y = "Electricity generation (GWh)")+
  scale_color_manual(values = linepalette1)
```



* Select MEA vspp and new vspp from PDP2018REV1

```{r tot_mea_vspp_pdp2018r1, echo=TRUE, warning=FALSE, message=FALSE}
# Select MEA vspp and new vspp from PDP2018REV1 ####
tot_mea_vspp_pdp2018r1 <- 
  
mea_vspp_pdp2018r1 %>% 
  select(year,fuel, mea_gwh) %>% 
  filter(fuel == "total")

tot_mea_newvspp_pdp2018r1 <-
  
mea_newvspp_pdp2018r1 %>% 
  select(year,fuel, mea_gwh) %>% 
  filter(fuel == "total")

tot_mea_vspp_pdp2018rev1 <-

tot_mea_vspp_pdp2018r1 %>%
  mutate(tot_mea_gwh = mea_gwh + tot_mea_newvspp_pdp2018r1$mea_gwh) %>% 
  select(!mea_gwh)
```

```{r}
tot_mea_vspp_pdp2018rev1 %>% 
  ggplot(aes(x = year,
             y = tot_mea_gwh))+
  geom_line(aes(group = fuel, color = fuel),
            show.legend = FALSE)+
  geom_point(shape = 21,
             size = 2,
             color = "dodgerblue",
             fill = "grey")+
  ThemeLine+
  labs(x = NULL,
       y = "VSPP Electricity generation (GWh)")+
  scale_x_continuous(breaks = c(2015, 2020, 2025, 2030, 2035, 2037))+
  scale_y_continuous(breaks = seq(0, 12000, 2000),
                     limits = c(0, 12000),
                     labels = comma)+
  scale_color_manual(values = "dodgerblue")
```



### Calculate EGAT sale from PDP2018REV1

The `left_join` function is used to combine a data frame and a calculated electricity sale from EGAT to MEA. It is calculated by a following equation.

\begin{equation}

EGTSLE_{MEA,t} = MEAReq_{t} - VSPP_{MEA,t}
(\#eq:egtsleMEApdp2018rev1)

\end{equation}

```{r egt_sle_mea_pdp2018r1, echo=TRUE, warning=FALSE, message=FALSE}

egt_sle_mea_pdp2018r1 <-

left_join(newmea_ene,
          tot_mea_vspp_pdp2018rev1%>% 
            select(year,tot_mea_gwh) %>% 
            filter(year >= 2019)) %>% 
  mutate(egatsale = mea_gwh - tot_mea_gwh)
```

```{r}
egt_sle_mea_pdp2018r1 %>% 
  ggplot()+
  geom_line(aes(x = year, y = egatsale))+
  geom_line(aes(x = year, y = mea_gwh))+
  geom_point(aes(x = year, y = egatsale),
             shape = 21,
             size = 2,
             color = "dodgerblue",
             fill = "grey")+
  geom_point(aes(x = year, y = mea_gwh),
             shape = 15,
             size = 2,
             color = "salmon",
             fill = "yellow",
             inherit.aes = FALSE)+
  geom_point(aes(x = year, y = mea_gwh))+
  ThemeLine+
  labs(x = NULL,
       y = "Electricity sale by EGAT to MEA (GWh")+
  scale_x_continuous(breaks = c(2019, 2025, 2030, 2035, 2037))
```


## VSPP in MEA region from PDP2023 case7

* Extract VSPP data

```{r tot_mea_vspp_pdp2022c7, echo=TRUE, warning=FALSE, message=FALSE}
tot_mea_vspp_pdp2022c7 <-
  
  
read_excel("raw_data/Case7_VSPP+DEDE+NVSPP_เพิ่มภาค.xlsx",
           sheet = "MAC",
           range = "A28:Q49",
           col_names = c("fuel", 2022:2037)) %>%
  replace(is.na(.), 0 ) %>% 
  pivot_longer(-fuel, names_to = "year", values_to = "mea_gwh") %>% 
  mutate(year = as.numeric(year)) %>% 
  pivot_wider(names_from = fuel, values_from = mea_gwh) %>% 
  rename_all(tolower) %>% 
  pivot_longer(-year, names_to = "fuel", values_to = "tot_mea_gwh") %>% 
  filter(fuel == "total")
```
* Join an electricity generation from VSPP in the MEA area and the PDP2022 case 7. The `full_join` function is used. 

```{r tot_mea_vspp_ene_pdp2022c7, echo=TRUE, message=FALSE, warning=FALSE}
tot_mea_vspp_ene_pdp2022c7 <-
  
full_join(mea_vspp_ene_ext %>% 
  filter(year >= 2015,
         fuel == "tot_vspp_gwh") %>% 
  select(year, year_th, mea_vspp_gwh),
tot_mea_vspp_pdp2022c7%>% 
  select(year,tot_mea_gwh) %>% 
  filter(year >= 2019) ,
by= c("mea_vspp_gwh" = "tot_mea_gwh",
      "year" = "year")) %>% 
  select(!year_th) 
```

### Calculate EGAT sale from PDP2022 Case 7

The `left_join` function is used to combine a data frame and a calculated electricity sale from EGAT to MEA. It is calculated by using equation \@ref(eq:egtsleMEApdp2018rev1).

```{r egt_sle_mea_pdp2022c7, echo=TRUE, warning=FALSE, message=FALSE}
egt_sle_mea_pdp2022c7 <-
  
  left_join(newmea_ene,
            tot_mea_vspp_ene_pdp2022c7 %>% 
              select(year,mea_vspp_gwh) %>% 
              filter(year >= 2019)) %>% 
  mutate(egatsale = mea_gwh - mea_vspp_gwh)
```

## Calculate electricity requirement in the MEA area

* Calculating for the worst case
```{r newmea_ene_req, echo=TRUE, warning=FALSE, message=FALSE}
### Calculating for worst case  
### Calculation for MEA electricity demand

newmea_ene_req <-
newload3u %>% 
  mutate(cumulative = lag(cumprod(grw_mea_dmd$growth),n = 0,default = 1)) %>% 
  mutate(mea_ene_req_gwh = cumulative * mea_ene_latest) %>% 
  select(year_th, year, mea_ene_req_gwh) %>% 
  mutate(tot_mea_vspp_pdp2018rev1 %>% 
           filter(year >= 2019)%>% 
           select(-year, -fuel)) %>% 
  select(year, year_th, mea_ene_req_gwh, mea_vspp_pdp2018r1 = tot_mea_gwh) %>% 
  mutate(egt_sle_mea_worst_case = mea_ene_req_gwh - mea_vspp_pdp2018r1)
```

